# Визуализация случайных примеров во время обучения

## Обзор

Добавлена модульная функция `visualize_random_predictions()` для визуализации случайных примеров распознавания во время валидации. Это помогает отслеживать качество модели "на глаз" и быстро замечать проблемы.

## Функционал

### Основные возможности

- ✅ Выбор случайных примеров из валидационного набора (каждый раз разные)
- ✅ Поддержка greedy и beam search декодирования
- ✅ Красивое форматирование вывода с маркерами ✓/✗
- ✅ Логирование через logger или print
- ✅ Модульная архитектура (не захламляет основной код)

### Что показывается

Для каждого примера выводится:
1. Номер примера и маркер корректности (✓ или ✗)
2. Ground Truth текст
3. Предсказанный текст

## Пример вывода

```
================================================================================
  ПРИМЕРЫ РАСПОЗНАВАНИЯ (Эпоха 15, режим: greedy)
================================================================================

  [ 1] ✓
       GT:   'Привет'
       Pred: 'Привет'

  [ 2] ✗
       GT:   'Мир'
       Pred: 'Мнр'

  [ 3] ✓
       GT:   'Тест'
       Pred: 'Тест'

  ...

================================================================================
```

## Интеграция в обучение

Функция автоматически вызывается после валидации на каждой эпохе:

1. **Greedy режим**: всегда показывается 10 случайных примеров
2. **Beam search**: если `dual_validate=True`, показываются еще 10 примеров

### Параметры

```python
visualize_random_predictions(
    model: nn.Module,           # Модель для инференса
    val_loader: DataLoader,     # Валидационный DataLoader
    itos: List[str],            # Список символов (индекс -> токен)
    pad_id: int,                # ID токена паддинга
    eos_id: int,                # ID токена конца последовательности
    blank_id: Optional[int],    # ID токена blank
    device: torch.device,       # Устройство (cuda/cpu)
    num_samples: int = 10,      # Количество примеров
    max_len: int = 25,          # Макс. длина последовательности
    mode: str = "greedy",       # "greedy" или "beam"
    epoch: Optional[int] = None,# Номер эпохи (для заголовка)
    logger: Optional[logging.Logger] = None,  # Logger
    **decode_kwargs              # beam_size, alpha, temperature
)
```

## Настройка

### Изменить количество примеров

В `src/manuscript/recognizers/_trba/training/train.py` найдите вызов функции и измените `num_samples`:

```python
visualize_random_predictions(
    model=model,
    val_loader=val_loaders_individual[0],
    ...
    num_samples=20,  # Вместо 10
    ...
)
```

### Отключить визуализацию

Просто закомментируйте блок с вызовом `visualize_random_predictions()` в `train.py`.

### Визуализировать только beam search

Закомментируйте первый вызов (greedy), оставьте только второй (внутри `if dual_validate:`).

## Производительность

- **Время выполнения**: ~0.1-0.5 секунд для 10 примеров (зависит от размера батчей)
- **Память**: минимальное потребление (обрабатывается по одному примеру)
- **Детерминизм**: нет, каждый раз выбираются новые случайные примеры

## Преимущества

1. **Быстрая диагностика**: сразу видно типичные ошибки модели
2. **Визуальная обратная связь**: не нужно ждать полных метрик
3. **Модульность**: функция отделена от основного кода обучения
4. **Гибкость**: легко настроить количество примеров и режим декодирования

## Пример использования в коде

```python
from manuscript.recognizers import TRBA

# Обучение с визуализацией (включена по умолчанию)
best_model = TRBA.train(
    train_csvs="data/train.csv",
    train_roots="data/images",
    val_csvs="data/val.csv",
    val_roots="data/val_images",
    dual_validate=True,  # Покажет примеры для greedy + beam
    epochs=100,
)
```

## Структура кода

### Файлы

- `src/manuscript/recognizers/_trba/training/train.py`:
  - Функция `visualize_random_predictions()` (строки ~195-350)
  - Вызов в процессе валидации (строки ~1077-1117)

### Зависимости

- `torch`: для работы с моделью
- `random`: для выбора случайных примеров
- `logging`: для логирования (опционально)

## Тестирование

Запустите тестовый скрипт:

```bash
python test_visualization.py
```

Скрипт проверяет:
- Корректность загрузки данных
- Работу greedy декодирования
- Работу beam search декодирования
- Форматирование вывода

## Возможные улучшения

1. **Сохранение изображений**: можно добавить сохранение картинок примеров
2. **TensorBoard интеграция**: визуализация в TensorBoard Images
3. **История примеров**: отслеживание одних и тех же примеров на разных эпохах
4. **Группировка по типу ошибок**: показывать самые сложные случаи
