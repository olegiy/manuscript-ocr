

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>manuscript.recognizers._trba &mdash; manuscript-ocr 0.1.9 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/language_switcher.css?v=d768f156" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=8618f531"></script>
      <script src="../../../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../../../_static/sphinx_highlight.js?v=6ffebe34"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.2.0/dist/mermaid-layout-elk.esm.min.mjs"></script>
      <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs";import elkLayouts from "https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.2.0/dist/mermaid-layout-elk.esm.min.mjs";mermaid.registerLayoutLoaders(elkLayouts);mermaid.initialize({startOnLoad:false});</script>
      <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
      <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs";

const defaultStyle = document.createElement('style');
defaultStyle.textContent = `pre.mermaid {
    /* Same as .mermaid-container > pre */
    display: block;
    width: 100%;
}

pre.mermaid > svg {
    /* Same as .mermaid-container > pre > svg */
    height: 500px;
    width: 100%;
    max-width: 100% !important;
}
`;
document.head.appendChild(defaultStyle);

const fullscreenStyle = document.createElement('style');
fullscreenStyle.textContent = `.mermaid-container {
    display: flex;
    flex-direction: row;
    width: 100%;
}

.mermaid-container > pre {
    display: block;
    width: 100%;
}

.mermaid-container > pre > svg {
    height: 500px;
    width: 100%;
    max-width: 100% !important;
}

.mermaid-fullscreen-btn {
    width: 28px;
    height: 28px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.3);
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    font-size: 14px;
    line-height: 1;
    padding: 0;
    color: #333;
}

.mermaid-fullscreen-btn:hover {
    opacity: 100% !important;
    background: rgba(255, 255, 255, 1);
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
    transform: scale(1.1);
}

.mermaid-fullscreen-btn.dark-theme {
    background: rgba(50, 50, 50, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: #e0e0e0;
}

.mermaid-fullscreen-btn.dark-theme:hover {
    background: rgba(60, 60, 60, 1);
    box-shadow: 0 3px 10px rgba(255, 255, 255, 0.2);
}

.mermaid-fullscreen-modal {
    display: none;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 95vw;
    height: 100vh;
    background: rgba(255, 255, 255, 0.98);
    z-index: 9999;
    padding: 20px;
    overflow: auto;
}

.mermaid-fullscreen-modal.dark-theme {
    background: rgba(0, 0, 0, 0.98);
}

.mermaid-fullscreen-modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen {
    position: relative;
    width: 95vw;
    height: 90vh;
    max-width: 95vw;
    max-height: 90vh;
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    overflow: auto;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen.dark-theme {
    background: #1a1a1a;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
}

.mermaid-container-fullscreen pre.mermaid {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen .mermaid svg {
    height: 100% !important;
    width: 100% !important;
    cursor: grab;
}

.mermaid-fullscreen-close {
    position: fixed !important;
    top: 20px !important;
    right: 20px !important;
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.2);
    border-radius: 50%;
    cursor: pointer;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    transition: all 0.2s;
    font-size: 24px;
    line-height: 1;
    color: #333;
}

.mermaid-fullscreen-close:hover {
    background: white;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    transform: scale(1.1);
}

.mermaid-fullscreen-close.dark-theme {
    background: rgba(50, 50, 50, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #e0e0e0;
}

.mermaid-fullscreen-close.dark-theme:hover {
    background: rgba(60, 60, 60, 1);
    box-shadow: 0 6px 16px rgba(255, 255, 255, 0.2);
}

.mermaid-fullscreen-modal .mermaid-fullscreen-btn {
    display: none !important;
}`;
document.head.appendChild(fullscreenStyle);

// Detect if page has dark background
const isDarkTheme = () => {
    const bgColor = window.getComputedStyle(document.body).backgroundColor;
    const match = bgColor.match(/rgb\((\d+),\s*(\d+),\s*(\d+)/);
    if (match) {
        const r = parseInt(match[1]);
        const g = parseInt(match[2]);
        const b = parseInt(match[3]);
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        return brightness < 128;
    }
    return false;
};

const load = async () => {
    await mermaid.run();

    const all_mermaids = document.querySelectorAll(".mermaid");
    const mermaids_processed = document.querySelectorAll(".mermaid[data-processed='true']");

    if ("False" === "True") {
        const mermaids_to_add_zoom = -1 === -1 ? all_mermaids.length : -1;
        if(mermaids_to_add_zoom > 0) {
            var svgs = d3.selectAll("");
            if(all_mermaids.length !== mermaids_processed.length) {
                setTimeout(load, 200);
                return;
            } else if(svgs.size() !== mermaids_to_add_zoom) {
                setTimeout(load, 200);
                return;
            } else {
                svgs.each(function() {
                    var svg = d3.select(this);
                    svg.html("<g class='wrapper'>" + svg.html() + "</g>");
                    var inner = svg.select("g");
                    var zoom = d3.zoom().on("zoom", function(event) {
                        inner.attr("transform", event.transform);
                    });
                    svg.call(zoom);
                });
            }
        }
    } else if(all_mermaids.length !== mermaids_processed.length) {
        // Wait for mermaid to process all diagrams
        setTimeout(load, 200);
        return;
    }

    const darkTheme = isDarkTheme();

    // Stop here if not adding fullscreen capability
    if ("True" !== "True") return;

    const modal = document.createElement('div');
    modal.className = 'mermaid-fullscreen-modal' + (darkTheme ? ' dark-theme' : '');
    modal.setAttribute('role', 'dialog');
    modal.setAttribute('aria-modal', 'true');
    modal.setAttribute('aria-label', 'Fullscreen diagram viewer');
    modal.innerHTML = `
        <button class="mermaid-fullscreen-close${darkTheme ? ' dark-theme' : ''}" aria-label="Close fullscreen">✕</button>
        <div class="mermaid-container-fullscreen${darkTheme ? ' dark-theme' : ''}"></div>
    `;
    document.body.appendChild(modal);

    const modalContent = modal.querySelector('.mermaid-container-fullscreen');
    const closeBtn = modal.querySelector('.mermaid-fullscreen-close');

    let previousScrollOffset = [window.scrollX, window.scrollY];

    const closeModal = () => {
        modal.classList.remove('active');
        modalContent.innerHTML = '';
        document.body.style.overflow = ''
        window.scrollTo({left: previousScrollOffset[0], top: previousScrollOffset[1], behavior: 'instant'});
    };

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
            closeModal();
        }
    });

    const allButtons = [];

    document.querySelectorAll('.mermaid').forEach((mermaidDiv) => {
        if (mermaidDiv.parentNode.classList.contains('mermaid-container') ||
            mermaidDiv.closest('.mermaid-fullscreen-modal')) {
            return;
        }

        const container = document.createElement('div');
        container.className = 'mermaid-container';
        mermaidDiv.parentNode.insertBefore(container, mermaidDiv);
        container.appendChild(mermaidDiv);

        const fullscreenBtn = document.createElement('button');
        fullscreenBtn.className = 'mermaid-fullscreen-btn' + (darkTheme ? ' dark-theme' : '');
        fullscreenBtn.setAttribute('aria-label', 'View diagram in fullscreen');
        fullscreenBtn.textContent = '⛶';
        fullscreenBtn.style.opacity = '50%';

        // Calculate dynamic position based on diagram's margin and padding
        const diagramStyle = window.getComputedStyle(mermaidDiv);
        const marginTop = parseFloat(diagramStyle.marginTop) || 0;
        const marginRight = parseFloat(diagramStyle.marginRight) || 0;
        const paddingTop = parseFloat(diagramStyle.paddingTop) || 0;
        const paddingRight = parseFloat(diagramStyle.paddingRight) || 0;
        fullscreenBtn.style.top = `${marginTop + paddingTop + 4}px`;
        fullscreenBtn.style.right = `${marginRight + paddingRight + 4}px`;

        fullscreenBtn.addEventListener('click', () => {
            previousScrollOffset = [window.scroll, window.scrollY];
            const clone = mermaidDiv.cloneNode(true);
            modalContent.innerHTML = '';
            modalContent.appendChild(clone);

            const svg = clone.querySelector('svg');
            if (svg) {
                svg.removeAttribute('width');
                svg.removeAttribute('height');
                svg.style.width = '100%';
                svg.style.height = 'auto';
                svg.style.maxWidth = '100%';
                svg.style.sdisplay = 'block';

                if ("False" === "True") {
                    setTimeout(() => {
                        const g = svg.querySelector('g');
                        if (g) {
                            var svgD3 = d3.select(svg);
                            svgD3.html("<g class='wrapper'>" + svgD3.html() + "</g>");
                            var inner = svgD3.select("g");
                            var zoom = d3.zoom().on("zoom", function(event) {
                                inner.attr("transform", event.transform);
                            });
                            svgD3.call(zoom);
                        }
                    }, 100);
                }
            }

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        });

        container.appendChild(fullscreenBtn);
        allButtons.push(fullscreenBtn);
    });

    // Update theme classes when theme changes
    const updateTheme = () => {
        const dark = isDarkTheme();
        allButtons.forEach(btn => {
            if (dark) {
                btn.classList.add('dark-theme');
            } else {
                btn.classList.remove('dark-theme');
            }
        });
        if (dark) {
            modal.classList.add('dark-theme');
            modalContent.classList.add('dark-theme');
            closeBtn.classList.add('dark-theme');
        } else {
            modal.classList.remove('dark-theme');
            modalContent.classList.remove('dark-theme');
            closeBtn.classList.remove('dark-theme');
        }
    };

    // Watch for theme changes
    const observer = new MutationObserver(updateTheme);
    observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['class', 'style', 'data-theme']
    });
    observer.observe(document.body, {
        attributes: true,
        attributeFilter: ['class', 'style']
    });
};

window.addEventListener("load", load);
</script>
      <script src="../../../_static/language_switcher.js?v=db730534"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            manuscript-ocr
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started.html#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started.html#quick-start">Quick Start</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started.html#main-components">Main Components</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../structure.html">Library Structure</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../structure.html#module-descriptions">Module Descriptions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/pipeline.html">Pipeline</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/pipeline.html#manuscript._pipeline.Pipeline"><code class="docutils literal notranslate"><span class="pre">Pipeline</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/pipeline.html#manuscript._pipeline.Pipeline.detector"><code class="docutils literal notranslate"><span class="pre">Pipeline.detector</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/pipeline.html#manuscript._pipeline.Pipeline.recognizer"><code class="docutils literal notranslate"><span class="pre">Pipeline.recognizer</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/pipeline.html#manuscript._pipeline.Pipeline.min_text_size"><code class="docutils literal notranslate"><span class="pre">Pipeline.min_text_size</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/pipeline.html#manuscript._pipeline.Pipeline.__init__"><code class="docutils literal notranslate"><span class="pre">Pipeline.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/pipeline.html#manuscript._pipeline.Pipeline.predict"><code class="docutils literal notranslate"><span class="pre">Pipeline.predict()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/pipeline.html#manuscript._pipeline.Pipeline.get_text"><code class="docutils literal notranslate"><span class="pre">Pipeline.get_text()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/data.html">Data Structures</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/data.html#data-model">Data Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/data.html#module-manuscript.data">API Reference</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/data.html#manuscript.data.Word"><code class="docutils literal notranslate"><span class="pre">Word</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/data.html#manuscript.data.Line"><code class="docutils literal notranslate"><span class="pre">Line</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/data.html#manuscript.data.Block"><code class="docutils literal notranslate"><span class="pre">Block</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/data.html#manuscript.data.Page"><code class="docutils literal notranslate"><span class="pre">Page</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/detectors.html">Detectors</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/detectors.html#manuscript.detectors.EAST"><code class="docutils literal notranslate"><span class="pre">EAST</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/detectors.html#manuscript.detectors.EAST.default_weights_name"><code class="docutils literal notranslate"><span class="pre">EAST.default_weights_name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/detectors.html#manuscript.detectors.EAST.pretrained_registry"><code class="docutils literal notranslate"><span class="pre">EAST.pretrained_registry</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/detectors.html#manuscript.detectors.EAST.__init__"><code class="docutils literal notranslate"><span class="pre">EAST.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/detectors.html#manuscript.detectors.EAST.predict"><code class="docutils literal notranslate"><span class="pre">EAST.predict()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/detectors.html#manuscript.detectors.EAST.train"><code class="docutils literal notranslate"><span class="pre">EAST.train()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/detectors.html#manuscript.detectors.EAST.export"><code class="docutils literal notranslate"><span class="pre">EAST.export()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/recognizers.html">Recognizers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/recognizers.html#manuscript.recognizers.TRBA"><code class="docutils literal notranslate"><span class="pre">TRBA</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/recognizers.html#manuscript.recognizers.TRBA.default_weights_name"><code class="docutils literal notranslate"><span class="pre">TRBA.default_weights_name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/recognizers.html#manuscript.recognizers.TRBA.pretrained_registry"><code class="docutils literal notranslate"><span class="pre">TRBA.pretrained_registry</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/recognizers.html#manuscript.recognizers.TRBA.config_registry"><code class="docutils literal notranslate"><span class="pre">TRBA.config_registry</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/recognizers.html#manuscript.recognizers.TRBA.charset_registry"><code class="docutils literal notranslate"><span class="pre">TRBA.charset_registry</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/recognizers.html#manuscript.recognizers.TRBA.__init__"><code class="docutils literal notranslate"><span class="pre">TRBA.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/recognizers.html#manuscript.recognizers.TRBA.predict"><code class="docutils literal notranslate"><span class="pre">TRBA.predict()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/recognizers.html#manuscript.recognizers.TRBA.train"><code class="docutils literal notranslate"><span class="pre">TRBA.train()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/recognizers.html#manuscript.recognizers.TRBA.export"><code class="docutils literal notranslate"><span class="pre">TRBA.export()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/utils.html">Utilities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utils.html#manuscript.utils.read_image"><code class="docutils literal notranslate"><span class="pre">read_image()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utils.html#manuscript.utils.visualize_page"><code class="docutils literal notranslate"><span class="pre">visualize_page()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utils.html#manuscript.utils.organize_page"><code class="docutils literal notranslate"><span class="pre">organize_page()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utils.html#manuscript.utils.set_seed"><code class="docutils literal notranslate"><span class="pre">set_seed()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">manuscript-ocr</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">manuscript.recognizers._trba</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for manuscript.recognizers._trba</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">onnxruntime</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ort</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">manuscript.api.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">manuscript.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">read_image</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.data.transforms</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_charset</span>

<span class="c1"># Optional imports for training (not needed for inference)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.training.train</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span><span class="p">,</span> <span class="n">run_training</span>

    <span class="n">_TRAINING_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">Config</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">run_training</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_TRAINING_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>


<div class="viewcode-block" id="TRBA">
<a class="viewcode-back" href="../../../api/recognizers.html#manuscript.recognizers.TRBA">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TRBA</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize TRBA text recognition model with ONNX Runtime.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    weights : str or Path, optional</span>
<span class="sd">        Path or identifier for ONNX model weights. Supports:</span>

<span class="sd">        - Local file path: ``&quot;path/to/model.onnx&quot;``</span>
<span class="sd">        - HTTP/HTTPS URL: ``&quot;https://example.com/model.onnx&quot;``</span>
<span class="sd">        - GitHub release: ``&quot;github://owner/repo/tag/file.onnx&quot;``</span>
<span class="sd">        - Google Drive: ``&quot;gdrive:FILE_ID&quot;``</span>
<span class="sd">        - Preset name: ``&quot;trba_lite_g1&quot;`` or ``&quot;trba_base_g1&quot;`` (from pretrained_registry)</span>
<span class="sd">        - ``None``: auto-downloads default preset (trba_lite_g1)</span>

<span class="sd">    config : str or Path, optional</span>
<span class="sd">        Path or identifier for model configuration JSON. Same URL schemes</span>
<span class="sd">        as ``weights``. If ``None``, attempts to infer from weights location</span>
<span class="sd">        or uses default config for preset models.</span>
<span class="sd">    charset : str or Path, optional</span>
<span class="sd">        Path or identifier for character set file. If ``None``, attempts to</span>
<span class="sd">        find charset near weights or falls back to package default.</span>
<span class="sd">    device : {&quot;cuda&quot;, &quot;coreml&quot;, &quot;cpu&quot;}, optional</span>
<span class="sd">        Compute device. If ``None``, automatically selects CPU.</span>
<span class="sd">        For GPU/CoreML acceleration:</span>

<span class="sd">        - CUDA (NVIDIA): ``pip install onnxruntime-gpu``</span>
<span class="sd">        - CoreML (Apple Silicon M1/M2/M3): ``pip install onnxruntime-silicon``</span>

<span class="sd">        Default is ``None`` (CPU).</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Additional configuration options (reserved for future use).</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    FileNotFoundError</span>
<span class="sd">        If specified files do not exist.</span>
<span class="sd">    ValueError</span>
<span class="sd">        If weights format is invalid.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The class provides three main public methods:</span>

<span class="sd">    - ``predict`` — run text recognition inference on cropped word images.</span>
<span class="sd">    - ``train`` — high-level training entrypoint to train a TRBA model</span>
<span class="sd">      on custom datasets.</span>
<span class="sd">    - ``export`` — static method to export PyTorch model to ONNX format.</span>

<span class="sd">    Model uses ONNX Runtime for fast inference on CPU and GPU.</span>
<span class="sd">    For GPU acceleration, install: ``pip install onnxruntime-gpu``</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Create recognizer with default preset (auto-downloads):</span>

<span class="sd">    &gt;&gt;&gt; from manuscript.recognizers import TRBA</span>
<span class="sd">    &gt;&gt;&gt; recognizer = TRBA()</span>

<span class="sd">    Load from local ONNX file:</span>

<span class="sd">    &gt;&gt;&gt; recognizer = TRBA(weights=&quot;path/to/model.onnx&quot;)</span>

<span class="sd">    Load from GitHub release:</span>

<span class="sd">    &gt;&gt;&gt; recognizer = TRBA(</span>
<span class="sd">    ...     weights=&quot;github://owner/repo/v1.0/model.onnx&quot;,</span>
<span class="sd">    ...     config=&quot;github://owner/repo/v1.0/config.json&quot;</span>
<span class="sd">    ... )</span>

<span class="sd">    Force CPU execution:</span>

<span class="sd">    &gt;&gt;&gt; recognizer = TRBA(weights=&quot;model.onnx&quot;, device=&quot;cpu&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">default_weights_name</span> <span class="o">=</span> <span class="s2">&quot;trba_lite_g1&quot;</span>

    <span class="n">pretrained_registry</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;trba_lite_g1&quot;</span><span class="p">:</span> <span class="s2">&quot;github://konstantinkozhin/manuscript-ocr/v0.1.0/trba_lite_g1.onnx&quot;</span><span class="p">,</span>
        <span class="s2">&quot;trba_base_g1&quot;</span><span class="p">:</span> <span class="s2">&quot;github://konstantinkozhin/manuscript-ocr/v0.1.0/trba_base_g1.onnx&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">config_registry</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;trba_lite_g1&quot;</span><span class="p">:</span> <span class="s2">&quot;github://konstantinkozhin/manuscript-ocr/v0.1.0/trba_lite_g1.json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;trba_base_g1&quot;</span><span class="p">:</span> <span class="s2">&quot;github://konstantinkozhin/manuscript-ocr/v0.1.0/trba_base_g1.json&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">charset_registry</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;trba_lite_g1&quot;</span><span class="p">:</span> <span class="s2">&quot;github://konstantinkozhin/manuscript-ocr/v0.1.0/trba_lite_g1.txt&quot;</span><span class="p">,</span>
        <span class="s2">&quot;trba_base_g1&quot;</span><span class="p">:</span> <span class="s2">&quot;github://konstantinkozhin/manuscript-ocr/v0.1.0/trba_base_g1.txt&quot;</span><span class="p">,</span>
    <span class="p">}</span>

<div class="viewcode-block" id="TRBA.__init__">
<a class="viewcode-back" href="../../../api/recognizers.html#manuscript.recognizers.TRBA.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">charset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># Initialize BaseModel (resolves weights and device)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Resolve config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

        <span class="c1"># Resolve charset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charset_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_charset</span><span class="p">(</span><span class="n">charset</span><span class="p">)</span>

        <span class="c1"># Load config</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_path</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Config file not found: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">config_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_len&quot;</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span> <span class="o">=</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hidden_size&quot;</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_encoder_layers</span> <span class="o">=</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_encoder_layers&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img_h</span> <span class="o">=</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;img_h&quot;</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img_w</span> <span class="o">=</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;img_w&quot;</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cnn_in_channels</span> <span class="o">=</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cnn_in_channels&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cnn_out_channels</span> <span class="o">=</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cnn_out_channels&quot;</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cnn_backbone</span> <span class="o">=</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cnn_backbone&quot;</span><span class="p">,</span> <span class="s2">&quot;seresnet31&quot;</span><span class="p">)</span>

        <span class="c1"># Load charset</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charset_path</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Charset file not found: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">charset_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">itos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stoi</span> <span class="o">=</span> <span class="n">load_charset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charset_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pad_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stoi</span><span class="p">[</span><span class="s2">&quot;&lt;PAD&gt;&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sos_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stoi</span><span class="p">[</span><span class="s2">&quot;&lt;SOS&gt;&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eos_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stoi</span><span class="p">[</span><span class="s2">&quot;&lt;EOS&gt;&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blank_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stoi</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;&lt;BLANK&gt;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Verify ONNX file exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model file not found: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;.onnx&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected .onnx file, got: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Initialize ONNX session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onnx_session</span> <span class="o">=</span> <span class="kc">None</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resolve config path using BaseModel&#39;s artifact resolution.</span>
<span class="sd">        Falls back to inferring from weights location.</span>

<span class="sd">        Search order:</span>
<span class="sd">        1. Explicit config parameter (if provided)</span>
<span class="sd">        2. Preset name from config_registry (if weights stem matches)</span>
<span class="sd">        3. Same filename as weights but with .json extension</span>
<span class="sd">        4. Default preset config</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Use BaseModel&#39;s universal resolver</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_extra_artifact</span><span class="p">(</span>
                <span class="n">config</span><span class="p">,</span>
                <span class="n">default_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">registry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config_registry</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;config&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Try to infer from weights location</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
        <span class="n">weights_stem</span> <span class="o">=</span> <span class="n">weights_path</span><span class="o">.</span><span class="n">stem</span>

        <span class="c1"># 1. Try preset name in config registry</span>
        <span class="k">if</span> <span class="n">weights_stem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_registry</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_extra_artifact</span><span class="p">(</span>
                <span class="n">weights_stem</span><span class="p">,</span>
                <span class="n">default_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">registry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config_registry</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;config&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># 2. Try same filename with .json extension (e.g., model.onnx → model.json)</span>
        <span class="n">config_candidate</span> <span class="o">=</span> <span class="n">weights_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config_candidate</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">config_candidate</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>

        <span class="c1"># 3. Use default preset config</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_weights_name</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_weights_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_registry</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_extra_artifact</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">default_weights_name</span><span class="p">,</span>
                <span class="n">default_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">registry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config_registry</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;config&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Could not find config file for weights: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Expected config at: </span><span class="si">{</span><span class="n">config_candidate</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Please specify config explicitly or ensure config file has same name as weights.&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_charset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">charset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resolve charset path using BaseModel&#39;s artifact resolution.</span>
<span class="sd">        Falls back to inferring from weights location or package default.</span>

<span class="sd">        Search order:</span>
<span class="sd">        1. Explicit charset parameter (if provided)</span>
<span class="sd">        2. Preset name from charset_registry (if weights stem matches)</span>
<span class="sd">        3. Same filename as weights but with .txt extension</span>
<span class="sd">        4. Default preset charset</span>
<span class="sd">        5. Package default charset (configs/charset.txt)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">charset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Use BaseModel&#39;s universal resolver</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_extra_artifact</span><span class="p">(</span>
                <span class="n">charset</span><span class="p">,</span>
                <span class="n">default_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">registry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charset_registry</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;charset&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Try to infer from weights location</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
        <span class="n">weights_stem</span> <span class="o">=</span> <span class="n">weights_path</span><span class="o">.</span><span class="n">stem</span>

        <span class="c1"># 1. Try preset name in charset registry</span>
        <span class="k">if</span> <span class="n">weights_stem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">charset_registry</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_extra_artifact</span><span class="p">(</span>
                <span class="n">weights_stem</span><span class="p">,</span>
                <span class="n">default_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">registry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charset_registry</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;charset&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># 2. Try same filename with .txt extension (e.g., model.onnx → model.txt)</span>
        <span class="n">charset_candidate</span> <span class="o">=</span> <span class="n">weights_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.txt&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">charset_candidate</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">charset_candidate</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>

        <span class="c1"># 3. Try default preset charset</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_weights_name</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_weights_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">charset_registry</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_extra_artifact</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">default_weights_name</span><span class="p">,</span>
                <span class="n">default_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">registry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charset_registry</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;charset&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># 4. Fallback to package default charset</span>
        <span class="n">current_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span>
        <span class="n">package_charset</span> <span class="o">=</span> <span class="n">current_dir</span> <span class="o">/</span> <span class="s2">&quot;configs&quot;</span> <span class="o">/</span> <span class="s2">&quot;charset.txt&quot;</span>
        <span class="k">if</span> <span class="n">package_charset</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">package_charset</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>

        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Could not find charset file. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Expected charset at: </span><span class="si">{</span><span class="n">charset_candidate</span><span class="si">}</span><span class="s2"> or </span><span class="si">{</span><span class="n">package_charset</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Please specify charset explicitly or ensure charset file has same name as weights.&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize ONNX Runtime session (lazy loading).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onnx_session</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">providers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runtime_providers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onnx_session</span> <span class="o">=</span> <span class="n">ort</span><span class="o">.</span><span class="n">InferenceSession</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">),</span> <span class="n">providers</span><span class="o">=</span><span class="n">providers</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_device_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">onnx_session</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_preprocess_image</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Preprocess image for ONNX inference. Returns [1, 3, H, W] numpy array.</span>

<span class="sd">        Applies same preprocessing as training:</span>
<span class="sd">        1. Load image (supports str, Path, np.ndarray, PIL.Image)</span>
<span class="sd">        2. Resize with aspect ratio preservation and padding</span>
<span class="sd">        3. Normalize with mean=0.5, std=0.5</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        image : str, Path, np.ndarray, or PIL.Image</span>
<span class="sd">            Input image in any supported format.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Preprocessed image tensor with shape [1, 3, H, W].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Load image using unified read_image utility (handles all formats)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">read_image</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>  <span class="c1"># Returns RGB uint8 [H, W, 3]</span>

        <span class="c1"># Resize with aspect ratio preservation and padding (like ResizeAndPadA)</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_h</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_w</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">new_w</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)))</span>
        <span class="n">new_h</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)))</span>

        <span class="c1"># Choose interpolation</span>
        <span class="k">if</span> <span class="n">new_h</span> <span class="o">&lt;</span> <span class="n">h</span> <span class="ow">or</span> <span class="n">new_w</span> <span class="o">&lt;</span> <span class="n">w</span><span class="p">:</span>
            <span class="n">interp</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">INTER_AREA</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">interp</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LINEAR</span>

        <span class="n">img_resized</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="n">new_w</span><span class="p">,</span> <span class="n">new_h</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interp</span><span class="p">)</span>

        <span class="c1"># Create white canvas and paste resized image</span>
        <span class="n">canvas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">img_h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_w</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">255</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="c1"># Center vertically, left align horizontally</span>
        <span class="n">y_offset</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_h</span> <span class="o">-</span> <span class="n">new_h</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">x_offset</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">canvas</span><span class="p">[</span><span class="n">y_offset</span> <span class="p">:</span> <span class="n">y_offset</span> <span class="o">+</span> <span class="n">new_h</span><span class="p">,</span> <span class="n">x_offset</span> <span class="p">:</span> <span class="n">x_offset</span> <span class="o">+</span> <span class="n">new_w</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_resized</span>

        <span class="c1"># Normalize: mean=(0.5, 0.5, 0.5), std=(0.5, 0.5, 0.5)</span>
        <span class="c1"># Equivalent to: (x / 255.0 - 0.5) / 0.5 = (x - 127.5) / 127.5</span>
        <span class="n">img_normalized</span> <span class="o">=</span> <span class="p">(</span><span class="n">canvas</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">-</span> <span class="mf">127.5</span><span class="p">)</span> <span class="o">/</span> <span class="mf">127.5</span>

        <span class="c1"># Convert to CHW format and add batch dimension</span>
        <span class="n">img_chw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">img_normalized</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># HWC -&gt; CHW</span>
        <span class="n">img_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">img_chw</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># [1, 3, H, W]</span>

        <span class="k">return</span> <span class="n">img_batch</span>

<div class="viewcode-block" id="TRBA.predict">
<a class="viewcode-back" href="../../../api/recognizers.html#manuscript.recognizers.TRBA.predict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">images</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">]]</span>
        <span class="p">],</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run text recognition on one or more word images.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        images : str, Path, numpy.ndarray, PIL.Image, or list thereof</span>
<span class="sd">            Single image or list of images to recognize. Each image can be:</span>

<span class="sd">            - Path to image file (str or Path)</span>
<span class="sd">            - RGB numpy array with shape ``(H, W, 3)`` in ``uint8``</span>
<span class="sd">            - PIL Image object</span>

<span class="sd">        batch_size : int, optional</span>
<span class="sd">            Number of images to process simultaneously. Larger batches are</span>
<span class="sd">            faster but require more memory. Default is 32.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of dict</span>
<span class="sd">            Recognition results as list of dictionaries, each containing:</span>

<span class="sd">            - ``&quot;text&quot;`` : str — recognized text</span>
<span class="sd">            - ``&quot;confidence&quot;`` : float — recognition confidence in [0, 1]</span>

<span class="sd">            If input is a single image, returns a list with one element.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        Recognize single image:</span>

<span class="sd">        &gt;&gt;&gt; from manuscript.recognizers import TRBA</span>
<span class="sd">        &gt;&gt;&gt; recognizer = TRBA()</span>
<span class="sd">        &gt;&gt;&gt; results = recognizer.predict(&quot;word_image.jpg&quot;)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Text: &#39;{results[0][&#39;text&#39;]}&#39; (confidence: {results[0][&#39;confidence&#39;]:.3f})&quot;)</span>

<span class="sd">        Process numpy arrays:</span>

<span class="sd">        &gt;&gt;&gt; import cv2</span>
<span class="sd">        &gt;&gt;&gt; img = cv2.imread(&quot;word.jpg&quot;)</span>
<span class="sd">        &gt;&gt;&gt; img_rgb = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)</span>
<span class="sd">        &gt;&gt;&gt; results = recognizer.predict(img_rgb)</span>
<span class="sd">        &gt;&gt;&gt; print(results[0][&quot;text&quot;])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialize session on first call</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onnx_session</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_session</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">images_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">images</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">images_list</span> <span class="o">=</span> <span class="n">images</span>

        <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Process images in batches</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">images_list</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
            <span class="n">batch_images</span> <span class="o">=</span> <span class="n">images_list</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>

            <span class="c1"># Preprocess batch</span>
            <span class="n">batch_tensors</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">batch_images</span><span class="p">:</span>
                <span class="n">tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_image</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>  <span class="c1"># [1, 3, H, W]</span>
                <span class="n">batch_tensors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tensor</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># Remove batch dim</span>

            <span class="n">batch_input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">batch_tensors</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># [B, 3, H, W]</span>

            <span class="c1"># ONNX inference</span>
            <span class="n">input_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onnx_session</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
            <span class="n">output_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onnx_session</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>

            <span class="n">ort_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onnx_session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="p">[</span><span class="n">output_name</span><span class="p">],</span> <span class="p">{</span><span class="n">input_name</span><span class="p">:</span> <span class="n">batch_input</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="n">logits</span> <span class="o">=</span> <span class="n">ort_outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># [B, max_length, num_classes]</span>

            <span class="c1"># Decode predictions</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [B, max_length]</span>

            <span class="c1"># Calculate confidence (softmax + mean log prob)</span>
            <span class="n">probs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_softmax</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [B, T, num_classes]</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_images</span><span class="p">)):</span>
                <span class="n">pred_row</span> <span class="o">=</span> <span class="n">preds</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>  <span class="c1"># [max_length]</span>

                <span class="c1"># Decode to text</span>
                <span class="n">decoded_chars</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">token_id</span> <span class="ow">in</span> <span class="n">pred_row</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">token_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">eos_id</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="n">token_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pad_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sos_id</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">token_id</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">itos</span><span class="p">):</span>
                            <span class="n">decoded_chars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">itos</span><span class="p">[</span><span class="n">token_id</span><span class="p">])</span>

                <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">decoded_chars</span><span class="p">)</span>

                <span class="c1"># Calculate confidence</span>
                <span class="n">seq_probs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">token_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pred_row</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">token_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">eos_id</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="n">token_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pad_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sos_id</span><span class="p">]:</span>
                        <span class="n">seq_probs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">probs</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">token_id</span><span class="p">])</span>

                <span class="n">confidence</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">seq_probs</span><span class="p">))</span> <span class="k">if</span> <span class="n">seq_probs</span> <span class="k">else</span> <span class="mf">0.0</span>

                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span> <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">results</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_softmax</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute softmax along axis.&quot;&quot;&quot;</span>
        <span class="n">exp_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">exp_x</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">exp_x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="TRBA.train">
<a class="viewcode-back" href="../../../api/recognizers.html#manuscript.recognizers.TRBA.train">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span>
        <span class="n">train_csvs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
        <span class="n">train_roots</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
        <span class="n">val_csvs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">val_roots</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">exp_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">charset_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
        <span class="n">img_h</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
        <span class="n">img_w</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
        <span class="n">max_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
        <span class="n">hidden_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
        <span class="n">num_encoder_layers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">cnn_in_channels</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">cnn_out_channels</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
        <span class="n">cnn_backbone</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;seresnet31&quot;</span><span class="p">,</span>
        <span class="n">ctc_weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
        <span class="n">ctc_weight_decay_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
        <span class="n">ctc_weight_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">max_grad_norm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
        <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span>
        <span class="n">optimizer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;AdamW&quot;</span><span class="p">,</span>
        <span class="n">scheduler</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;OneCycleLR&quot;</span><span class="p">,</span>
        <span class="n">weight_decay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">momentum</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span>
        <span class="n">val_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">val_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">,</span>
        <span class="n">train_proportions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">num_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
        <span class="n">resume_from</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_interval</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span><span class="p">,</span>
        <span class="n">freeze_cnn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span>
        <span class="n">freeze_enc_rnn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span>
        <span class="n">freeze_attention</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span>
        <span class="n">pretrain_weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">extra_config</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Train TRBA text recognition model on custom datasets.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        train_csvs : str, Path or sequence of paths</span>
<span class="sd">            Path(s) to training CSV files. Each CSV should have columns:</span>
<span class="sd">            ``image_path`` (relative to ``train_roots``) and ``text`` (ground</span>
<span class="sd">            truth transcription).</span>
<span class="sd">        train_roots : str, Path or sequence of paths</span>
<span class="sd">            Root directory/directories containing training images. Must have</span>
<span class="sd">            same length as ``train_csvs``.</span>
<span class="sd">        val_csvs : str, Path, sequence of paths, or None, optional</span>
<span class="sd">            Path(s) to validation CSV files with same format as ``train_csvs``.</span>
<span class="sd">            If ``None``, no validation is performed. Default is ``None``.</span>
<span class="sd">        val_roots : str, Path, sequence of paths, or None, optional</span>
<span class="sd">            Root directory/directories for validation images. Must match length</span>
<span class="sd">            of ``val_csvs`` if provided. Default is ``None``.</span>
<span class="sd">        exp_dir : str or Path, optional</span>
<span class="sd">            Experiment directory where checkpoints and logs will be saved.</span>
<span class="sd">            If ``None``, auto-generated based on timestamp. Default is ``None``.</span>
<span class="sd">        charset_path : str or Path, optional</span>
<span class="sd">            Path to character set file. If ``None``, uses default charset from</span>
<span class="sd">            package. Default is ``None``.</span>
<span class="sd">        encoding : str, optional</span>
<span class="sd">            Text encoding for reading CSV files. Default is ``&quot;utf-8&quot;``.</span>
<span class="sd">        img_h : int, optional</span>
<span class="sd">            Target height for input images (pixels). Default is 64.</span>
<span class="sd">        img_w : int, optional</span>
<span class="sd">            Target width for input images (pixels). Default is 256.</span>
<span class="sd">        max_len : int, optional</span>
<span class="sd">            Maximum sequence length for text recognition. Default is 25.</span>
<span class="sd">        hidden_size : int, optional</span>
<span class="sd">            Hidden dimension size for RNN encoder/decoder. Default is 256.</span>
<span class="sd">        num_encoder_layers : int, optional</span>
<span class="sd">            Number of Bidirectional LSTM layers in the encoder. Default is 2.</span>
<span class="sd">        cnn_in_channels : int, optional</span>
<span class="sd">            Number of input channels for CNN backbone (3 for RGB, 1 for grayscale). Default is 3.</span>
<span class="sd">        cnn_out_channels : int, optional</span>
<span class="sd">            Number of output channels from CNN backbone. Default is 512.</span>
<span class="sd">        cnn_backbone : {&quot;seresnet31&quot;, &quot;seresnet31-lite&quot;}, optional</span>
<span class="sd">            CNN backbone variant. ``&quot;seresnet31&quot;`` keeps the standard SE-ResNet-31,</span>
<span class="sd">            while ``&quot;seresnet31-lite&quot;`` enables a depthwise-lite version. Default is ``&quot;seresnet31&quot;``.</span>
<span class="sd">        ctc_weight : float, optional</span>
<span class="sd">            Initial weight for CTC loss during training (CTC always used for stability):</span>
<span class="sd">            ``loss = attn_loss * (1 - ctc_weight) + ctc_loss * ctc_weight``.</span>
<span class="sd">            CTC weight decays over epochs. Default is 0.3.</span>
<span class="sd">        ctc_weight_decay_epochs : int, optional</span>
<span class="sd">            Number of epochs for CTC weight to decay to minimum. Default is 50.</span>
<span class="sd">        ctc_weight_min : float, optional</span>
<span class="sd">            Minimum value for CTC weight after decay. Default is 0.0.</span>
<span class="sd">        max_grad_norm : float, optional</span>
<span class="sd">            Maximum gradient norm for clipping (prevents gradient explosion/NaN).</span>
<span class="sd">            Default is 5.0.</span>
<span class="sd">        batch_size : int, optional</span>
<span class="sd">            Training batch size. Default is 32.</span>
<span class="sd">        epochs : int, optional</span>
<span class="sd">            Number of training epochs. Default is 20.</span>
<span class="sd">        lr : float, optional</span>
<span class="sd">            Learning rate. Default is 1e-3.</span>
<span class="sd">        optimizer : {&quot;Adam&quot;, &quot;SGD&quot;, &quot;AdamW&quot;}, optional</span>
<span class="sd">            Optimizer type. Default is ``&quot;AdamW&quot;``.</span>
<span class="sd">        scheduler : {&quot;ReduceLROnPlateau&quot;, &quot;CosineAnnealingLR&quot;, &quot;OneCycleLR&quot;, &quot;None&quot;}, optional</span>
<span class="sd">            Learning rate scheduler type:</span>

<span class="sd">            - ``&quot;OneCycleLR&quot;`` — one-cycle policy with cosine annealing (default, recommended)</span>
<span class="sd">            - ``&quot;ReduceLROnPlateau&quot;`` — reduce LR on validation loss plateau</span>
<span class="sd">            - ``&quot;CosineAnnealingLR&quot;`` — cosine annealing over epochs</span>
<span class="sd">            - ``&quot;None&quot;`` or ``None`` — constant learning rate</span>

<span class="sd">            Default is ``&quot;OneCycleLR&quot;``.</span>
<span class="sd">        weight_decay : float, optional</span>
<span class="sd">            L2 weight decay coefficient. Default is 0.0.</span>
<span class="sd">        momentum : float, optional</span>
<span class="sd">            Momentum for SGD optimizer. Default is 0.9.</span>
<span class="sd">        val_interval : int, optional</span>
<span class="sd">            Perform validation every N epochs. Default is 1.</span>
<span class="sd">        val_size : int, optional</span>
<span class="sd">            Maximum number of validation samples to use. Default is 3000.</span>
<span class="sd">        train_proportions : sequence of float, optional</span>
<span class="sd">            Sampling proportions for multiple training datasets. Must sum to 1.0</span>
<span class="sd">            and match length of ``train_csvs``. If ``None``, datasets are</span>
<span class="sd">            concatenated equally. Default is ``None``.</span>
<span class="sd">        num_workers : int, optional</span>
<span class="sd">            Number of data loading workers. Default is 0.</span>
<span class="sd">        seed : int, optional</span>
<span class="sd">            Random seed for reproducibility. Default is 42.</span>
<span class="sd">        resume_from : str or Path, optional</span>
<span class="sd">            Path to checkpoint file to resume training from. Default is ``None``.</span>
<span class="sd">        save_interval : int, optional</span>
<span class="sd">            Save checkpoint every N epochs. If ``None``, only saves best model.</span>
<span class="sd">            Default is ``None``.</span>
<span class="sd">        device : {&quot;cuda&quot;, &quot;cpu&quot;}, optional</span>
<span class="sd">            Training device. Default is ``&quot;cuda&quot;``.</span>
<span class="sd">        freeze_cnn : {&quot;none&quot;, &quot;all&quot;, &quot;first&quot;, &quot;last&quot;}, optional</span>
<span class="sd">            CNN freezing policy. Default is ``&quot;none&quot;``.</span>
<span class="sd">        freeze_enc_rnn : {&quot;none&quot;, &quot;all&quot;, &quot;first&quot;, &quot;last&quot;}, optional</span>
<span class="sd">            Encoder RNN freezing policy. Default is ``&quot;none&quot;``.</span>
<span class="sd">        freeze_attention : {&quot;none&quot;, &quot;all&quot;}, optional</span>
<span class="sd">            Attention module freezing policy. Default is ``&quot;none&quot;``.</span>
<span class="sd">        pretrain_weights : str, Path, bool, or None, optional</span>
<span class="sd">            Pretrained weights to initialize from:</span>

<span class="sd">            - ``&quot;default&quot;`` or ``True`` — use release weights</span>
<span class="sd">            - ``None`` or ``False`` — train from scratch</span>
<span class="sd">            - str/Path — path or URL to custom weights file</span>

<span class="sd">            Default is ``&quot;default&quot;``.</span>
<span class="sd">        **extra_config : dict, optional</span>
<span class="sd">            Additional configuration parameters passed to training config.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            Path to the best model checkpoint saved during training.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        Train on single dataset with validation:</span>

<span class="sd">        &gt;&gt;&gt; from manuscript.recognizers import TRBA</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; best_model = TRBA.train(</span>
<span class="sd">        ...     train_csvs=&quot;data/train.csv&quot;,</span>
<span class="sd">        ...     train_roots=&quot;data/train_images&quot;,</span>
<span class="sd">        ...     val_csvs=&quot;data/val.csv&quot;,</span>
<span class="sd">        ...     val_roots=&quot;data/val_images&quot;,</span>
<span class="sd">        ...     exp_dir=&quot;./experiments/trba_exp1&quot;,</span>
<span class="sd">        ...     epochs=50,</span>
<span class="sd">        ...     batch_size=64,</span>
<span class="sd">        ...     img_h=64,</span>
<span class="sd">        ...     img_w=256,</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Best model saved at: {best_model}&quot;)</span>

<span class="sd">        Train on multiple datasets with custom proportions:</span>

<span class="sd">        &gt;&gt;&gt; train_csvs = [&quot;data/dataset1/train.csv&quot;, &quot;data/dataset2/train.csv&quot;]</span>
<span class="sd">        &gt;&gt;&gt; train_roots = [&quot;data/dataset1/images&quot;, &quot;data/dataset2/images&quot;]</span>
<span class="sd">        &gt;&gt;&gt; train_proportions = [0.7, 0.3]  # 70% from dataset1, 30% from dataset2</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; best_model = TRBA.train(</span>
<span class="sd">        ...     train_csvs=train_csvs,</span>
<span class="sd">        ...     train_roots=train_roots,</span>
<span class="sd">        ...     train_proportions=train_proportions,</span>
<span class="sd">        ...     val_csvs=&quot;data/val.csv&quot;,</span>
<span class="sd">        ...     val_roots=&quot;data/val_images&quot;,</span>
<span class="sd">        ...     epochs=100,</span>
<span class="sd">        ...     lr=5e-4,</span>
<span class="sd">        ...     optimizer=&quot;AdamW&quot;,</span>
<span class="sd">        ...     weight_decay=1e-4,</span>
<span class="sd">        ... )</span>

<span class="sd">        Resume training from checkpoint:</span>

<span class="sd">        &gt;&gt;&gt; best_model = TRBA.train(</span>
<span class="sd">        ...     train_csvs=&quot;data/train.csv&quot;,</span>
<span class="sd">        ...     train_roots=&quot;data/train_images&quot;,</span>
<span class="sd">        ...     resume_from=&quot;experiments/trba_exp1/checkpoints/last.pth&quot;,</span>
<span class="sd">        ...     epochs=100,</span>
<span class="sd">        ... )</span>

<span class="sd">        Fine-tune from pretrained weights with frozen CNN:</span>

<span class="sd">        &gt;&gt;&gt; best_model = TRBA.train(</span>
<span class="sd">        ...     train_csvs=&quot;data/finetune.csv&quot;,</span>
<span class="sd">        ...     train_roots=&quot;data/finetune_images&quot;,</span>
<span class="sd">        ...     pretrain_weights=&quot;default&quot;,</span>
<span class="sd">        ...     freeze_cnn=&quot;all&quot;,</span>
<span class="sd">        ...     epochs=20,</span>
<span class="sd">        ...     lr=1e-4,</span>
<span class="sd">        ... )</span>

<span class="sd">        Train with CTC for stability (always enabled):</span>

<span class="sd">        &gt;&gt;&gt; best_model = TRBA.train(</span>
<span class="sd">        ...     train_csvs=&quot;data/train.csv&quot;,</span>
<span class="sd">        ...     train_roots=&quot;data/train_images&quot;,</span>
<span class="sd">        ...     optimizer=&quot;AdamW&quot;,</span>
<span class="sd">        ...     scheduler=&quot;OneCycleLR&quot;,</span>
<span class="sd">        ...     lr=1e-3,</span>
<span class="sd">        ...     ctc_weight=0.3,</span>
<span class="sd">        ...     ctc_weight_decay_epochs=50,</span>
<span class="sd">        ...     max_grad_norm=5.0,</span>
<span class="sd">        ...     epochs=100,</span>
<span class="sd">        ... )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_TRAINING_AVAILABLE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">&quot;Training dependencies not available. &quot;</span>
                <span class="s2">&quot;Install with: pip install manuscript-ocr[dev]&quot;</span>
            <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_path_list</span><span class="p">(</span>
            <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]],</span>
            <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">allow_none</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">allow_item_none</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">allow_none</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2"> must be provided&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">raw_items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">raw_items</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">raw_items</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2"> must not be empty&quot;</span><span class="p">)</span>

            <span class="n">result</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">raw_items</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">allow_item_none</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2"> contains None but allow_item_none is False&quot;</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">fspath</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="n">train_csvs_list</span> <span class="o">=</span> <span class="n">_ensure_path_list</span><span class="p">(</span><span class="n">train_csvs</span><span class="p">,</span> <span class="s2">&quot;train_csvs&quot;</span><span class="p">)</span>
        <span class="n">train_roots_list</span> <span class="o">=</span> <span class="n">_ensure_path_list</span><span class="p">(</span><span class="n">train_roots</span><span class="p">,</span> <span class="s2">&quot;train_roots&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_csvs_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_roots_list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;train_csvs and train_roots must contain the same number of items&quot;</span>
            <span class="p">)</span>

        <span class="n">val_csvs_list</span> <span class="o">=</span> <span class="n">_ensure_path_list</span><span class="p">(</span>
            <span class="n">val_csvs</span><span class="p">,</span> <span class="s2">&quot;val_csvs&quot;</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_item_none</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">val_roots_list</span> <span class="o">=</span> <span class="n">_ensure_path_list</span><span class="p">(</span>
            <span class="n">val_roots</span><span class="p">,</span> <span class="s2">&quot;val_roots&quot;</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_item_none</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">val_csvs_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">val_roots_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;val_csvs and val_roots must both be provided or both be None&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">val_csvs_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_csvs_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_roots_list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;val_csvs and val_roots must contain the same number of items&quot;</span>
            <span class="p">)</span>

        <span class="n">resolved_charset</span> <span class="o">=</span> <span class="n">charset_path</span>
        <span class="k">if</span> <span class="n">resolved_charset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">current_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
            <span class="n">resolved_charset</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_dir</span><span class="p">,</span> <span class="s2">&quot;configs&quot;</span><span class="p">,</span> <span class="s2">&quot;charset.txt&quot;</span><span class="p">)</span>

        <span class="n">config_payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;train_csvs&quot;</span><span class="p">:</span> <span class="n">train_csvs_list</span><span class="p">,</span>
            <span class="s2">&quot;train_roots&quot;</span><span class="p">:</span> <span class="n">train_roots_list</span><span class="p">,</span>
            <span class="s2">&quot;charset_path&quot;</span><span class="p">:</span> <span class="n">resolved_charset</span><span class="p">,</span>
            <span class="s2">&quot;encoding&quot;</span><span class="p">:</span> <span class="n">encoding</span><span class="p">,</span>
            <span class="s2">&quot;img_h&quot;</span><span class="p">:</span> <span class="n">img_h</span><span class="p">,</span>
            <span class="s2">&quot;img_w&quot;</span><span class="p">:</span> <span class="n">img_w</span><span class="p">,</span>
            <span class="s2">&quot;max_len&quot;</span><span class="p">:</span> <span class="n">max_len</span><span class="p">,</span>
            <span class="s2">&quot;hidden_size&quot;</span><span class="p">:</span> <span class="n">hidden_size</span><span class="p">,</span>
            <span class="s2">&quot;num_encoder_layers&quot;</span><span class="p">:</span> <span class="n">num_encoder_layers</span><span class="p">,</span>
            <span class="s2">&quot;cnn_in_channels&quot;</span><span class="p">:</span> <span class="n">cnn_in_channels</span><span class="p">,</span>
            <span class="s2">&quot;cnn_out_channels&quot;</span><span class="p">:</span> <span class="n">cnn_out_channels</span><span class="p">,</span>
            <span class="s2">&quot;cnn_backbone&quot;</span><span class="p">:</span> <span class="n">cnn_backbone</span><span class="p">,</span>
            <span class="s2">&quot;ctc_weight&quot;</span><span class="p">:</span> <span class="n">ctc_weight</span><span class="p">,</span>
            <span class="s2">&quot;ctc_weight_decay_epochs&quot;</span><span class="p">:</span> <span class="n">ctc_weight_decay_epochs</span><span class="p">,</span>
            <span class="s2">&quot;ctc_weight_min&quot;</span><span class="p">:</span> <span class="n">ctc_weight_min</span><span class="p">,</span>
            <span class="s2">&quot;max_grad_norm&quot;</span><span class="p">:</span> <span class="n">max_grad_norm</span><span class="p">,</span>
            <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="n">batch_size</span><span class="p">,</span>
            <span class="s2">&quot;epochs&quot;</span><span class="p">:</span> <span class="n">epochs</span><span class="p">,</span>
            <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="n">lr</span><span class="p">,</span>
            <span class="s2">&quot;optimizer&quot;</span><span class="p">:</span> <span class="n">optimizer</span><span class="p">,</span>
            <span class="s2">&quot;scheduler&quot;</span><span class="p">:</span> <span class="n">scheduler</span><span class="p">,</span>
            <span class="s2">&quot;weight_decay&quot;</span><span class="p">:</span> <span class="n">weight_decay</span><span class="p">,</span>
            <span class="s2">&quot;momentum&quot;</span><span class="p">:</span> <span class="n">momentum</span><span class="p">,</span>
            <span class="s2">&quot;val_interval&quot;</span><span class="p">:</span> <span class="n">val_interval</span><span class="p">,</span>
            <span class="s2">&quot;val_size&quot;</span><span class="p">:</span> <span class="n">val_size</span><span class="p">,</span>
            <span class="s2">&quot;num_workers&quot;</span><span class="p">:</span> <span class="n">num_workers</span><span class="p">,</span>
            <span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">exp_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config_payload</span><span class="p">[</span><span class="s2">&quot;exp_dir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp_dir</span>
        <span class="k">if</span> <span class="n">val_csvs_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config_payload</span><span class="p">[</span><span class="s2">&quot;val_csvs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val_csvs_list</span>
            <span class="n">config_payload</span><span class="p">[</span><span class="s2">&quot;val_roots&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val_roots_list</span>
        <span class="k">if</span> <span class="n">train_proportions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config_payload</span><span class="p">[</span><span class="s2">&quot;train_proportions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">train_proportions</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resume_from</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config_payload</span><span class="p">[</span><span class="s2">&quot;resume_from&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resume_from</span>
        <span class="k">if</span> <span class="n">save_interval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config_payload</span><span class="p">[</span><span class="s2">&quot;save_interval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_interval</span>
        <span class="c1"># Pretrained weights option:</span>
        <span class="c1"># - None/False/&quot;none&quot;: skip</span>
        <span class="c1"># - &quot;default&quot;/True: use release weights</span>
        <span class="c1"># - str: path/URL to .pth/.pt/.ckpt</span>
        <span class="k">if</span> <span class="n">pretrain_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config_payload</span><span class="p">[</span><span class="s2">&quot;pretrain_weights&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pretrain_weights</span>

        <span class="k">if</span> <span class="n">extra_config</span><span class="p">:</span>
            <span class="n">config_payload</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extra_config</span><span class="p">)</span>

        <span class="c1"># Freeze policies for model submodules</span>
        <span class="n">config_payload</span><span class="p">[</span><span class="s2">&quot;freeze_cnn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">freeze_cnn</span>
        <span class="n">config_payload</span><span class="p">[</span><span class="s2">&quot;freeze_enc_rnn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">freeze_enc_rnn</span>
        <span class="n">config_payload</span><span class="p">[</span><span class="s2">&quot;freeze_attention&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">freeze_attention</span>

        <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="n">config_payload</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">run_training</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span></div>


<div class="viewcode-block" id="TRBA.export">
<a class="viewcode-back" href="../../../api/recognizers.html#manuscript.recognizers.TRBA.export">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">export</span><span class="p">(</span>
        <span class="n">weights_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">],</span>
        <span class="n">config_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">],</span>
        <span class="n">charset_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">],</span>
        <span class="n">output_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">],</span>
        <span class="n">opset_version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
        <span class="n">simplify</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export TRBA PyTorch model to ONNX format.</span>

<span class="sd">        This method converts a trained TRBA model from PyTorch to ONNX format,</span>
<span class="sd">        which can be used for faster inference with ONNX Runtime. The exported</span>
<span class="sd">        model can be loaded using ``TRBA(weights=&quot;model.onnx&quot;)``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        weights_path : str or Path</span>
<span class="sd">            Path to the PyTorch model weights file (.pth).</span>
<span class="sd">        config_path : str or Path</span>
<span class="sd">            Path to the model configuration JSON file. Used to determine</span>
<span class="sd">            model architecture (img_h, img_w, max_len, hidden_size, etc.).</span>
<span class="sd">        charset_path : str or Path</span>
<span class="sd">            Path to the charset file (charset.txt). Used to determine</span>
<span class="sd">            num_classes for the model.</span>
<span class="sd">        output_path : str or Path</span>
<span class="sd">            Path where the ONNX model will be saved (.onnx).</span>
<span class="sd">        opset_version : int, optional</span>
<span class="sd">            ONNX opset version to use for export. Default is 14.</span>
<span class="sd">        simplify : bool, optional</span>
<span class="sd">            If True, applies ONNX graph simplification using onnx-simplifier</span>
<span class="sd">            to optimize the model. Requires ``onnx-simplifier`` package.</span>
<span class="sd">            Default is True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">            The ONNX model is saved to ``output_path``.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ImportError</span>
<span class="sd">            If required packages (torch, onnx) are not installed.</span>
<span class="sd">        FileNotFoundError</span>
<span class="sd">            If ``weights_path`` or ``config_path`` do not exist.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The exported ONNX model has one output:</span>

<span class="sd">        - ``logits``: Character predictions with shape ``(batch, max_length+1, num_classes)``</span>

<span class="sd">        The model uses greedy decoding (argmax) and supports dynamic batch size.</span>
<span class="sd">        The sequence length is fixed to ``max_length + 1`` from the config (same as PyTorch</span>
<span class="sd">        inference mode for compatibility).</span>

<span class="sd">        Architecture exported:</span>
<span class="sd">        - CNN backbone (SE-ResNet-31 or SE-ResNet-31-Lite)</span>
<span class="sd">        - Bidirectional LSTM encoder</span>
<span class="sd">        - Attention decoder (greedy decoding)</span>

<span class="sd">        Note: Only the attention decoder is exported. CTC head is used only</span>
<span class="sd">        during training and is not included in the ONNX model.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        Export TRBA model to ONNX:</span>

<span class="sd">        &gt;&gt;&gt; from manuscript.recognizers import TRBA</span>
<span class="sd">        &gt;&gt;&gt; TRBA.export(</span>
<span class="sd">        ...     weights_path=&quot;experiments/best_model/best_acc_weights.pth&quot;,</span>
<span class="sd">        ...     config_path=&quot;experiments/best_model/config.json&quot;,</span>
<span class="sd">        ...     charset_path=&quot;configs/charset.txt&quot;,</span>
<span class="sd">        ...     output_path=&quot;trba_model.onnx&quot;</span>
<span class="sd">        ... )</span>
<span class="sd">        Loading TRBA model...</span>
<span class="sd">        === TRBA ONNX Export ===</span>
<span class="sd">        Max decoding length: 40</span>
<span class="sd">        Input size: 64x256</span>
<span class="sd">        [OK] ONNX model saved to: trba_model.onnx</span>

<span class="sd">        Export with custom opset:</span>

<span class="sd">        &gt;&gt;&gt; TRBA.export(</span>
<span class="sd">        ...     weights_path=&quot;model.pth&quot;,</span>
<span class="sd">        ...     config_path=&quot;config.json&quot;,</span>
<span class="sd">        ...     charset_path=&quot;charset.txt&quot;,</span>
<span class="sd">        ...     output_path=&quot;model.onnx&quot;,</span>
<span class="sd">        ...     opset_version=16,</span>
<span class="sd">        ...     simplify=False</span>
<span class="sd">        ... )</span>

<span class="sd">        Use the exported model for inference:</span>

<span class="sd">        &gt;&gt;&gt; recognizer = TRBA(weights=&quot;trba_model.onnx&quot;)</span>
<span class="sd">        &gt;&gt;&gt; result = recognizer.predict(&quot;word_image.jpg&quot;)</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        TRBA.__init__ : Initialize TRBA recognizer with ONNX model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.model.model</span><span class="w"> </span><span class="kn">import</span> <span class="n">TRBAModel</span><span class="p">,</span> <span class="n">TRBAONNXWrapper</span>

        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">weights_path</span><span class="p">)</span>
        <span class="n">config_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
        <span class="n">charset_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">charset_path</span><span class="p">)</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">weights_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Weights file not found: </span><span class="si">{</span><span class="n">weights_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Config file not found: </span><span class="si">{</span><span class="n">config_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">charset_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Charset file not found: </span><span class="si">{</span><span class="n">charset_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Load config</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading config from </span><span class="si">{</span><span class="n">config_path</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="c1"># Extract model parameters</span>
        <span class="n">max_length</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_len&quot;</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
        <span class="n">img_h</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;img_h&quot;</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
        <span class="n">img_w</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;img_w&quot;</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
        <span class="n">hidden_size</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hidden_size&quot;</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
        <span class="n">num_encoder_layers</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_encoder_layers&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">cnn_in_channels</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cnn_in_channels&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">cnn_out_channels</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cnn_out_channels&quot;</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
        <span class="n">cnn_backbone</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cnn_backbone&quot;</span><span class="p">,</span> <span class="s2">&quot;seresnet31&quot;</span><span class="p">)</span>

        <span class="c1"># Load charset to determine num_classes</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading charset from </span><span class="si">{</span><span class="n">charset_path</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="n">itos</span><span class="p">,</span> <span class="n">stoi</span> <span class="o">=</span> <span class="n">load_charset</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">charset_path</span><span class="p">))</span>
        <span class="n">num_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">itos</span>
        <span class="p">)</span>  <span class="c1"># itos already includes special tokens (PAD, SOS, EOS, BLANK, ...)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Charset loaded: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">itos</span><span class="p">)</span><span class="si">}</span><span class="s2"> total classes (including special tokens)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  First 4 tokens (special): </span><span class="si">{</span><span class="n">itos</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Regular characters: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">itos</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">4</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Load weights</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Loading checkpoint from </span><span class="si">{</span><span class="n">weights_path</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">weights_path</span><span class="p">),</span> <span class="n">map_location</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;model_state_dict&quot;</span> <span class="ow">in</span> <span class="n">checkpoint</span><span class="p">:</span>
            <span class="n">state_dict</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;model_state_dict&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">state_dict</span> <span class="o">=</span> <span class="n">checkpoint</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== TRBA ONNX Export ===&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max decoding length: </span><span class="si">{</span><span class="n">max_length</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input size: </span><span class="si">{</span><span class="n">img_h</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">img_w</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Architecture: </span><span class="si">{</span><span class="n">cnn_backbone</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hidden size: </span><span class="si">{</span><span class="n">hidden_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Num classes: </span><span class="si">{</span><span class="n">num_classes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Create PyTorch model with correct num_classes and token IDs</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Creating model architecture...&quot;</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">TRBAModel</span><span class="p">(</span>
            <span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span><span class="p">,</span>
            <span class="n">hidden_size</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span>
            <span class="n">num_encoder_layers</span><span class="o">=</span><span class="n">num_encoder_layers</span><span class="p">,</span>
            <span class="n">img_h</span><span class="o">=</span><span class="n">img_h</span><span class="p">,</span>
            <span class="n">img_w</span><span class="o">=</span><span class="n">img_w</span><span class="p">,</span>
            <span class="n">cnn_in_channels</span><span class="o">=</span><span class="n">cnn_in_channels</span><span class="p">,</span>
            <span class="n">cnn_out_channels</span><span class="o">=</span><span class="n">cnn_out_channels</span><span class="p">,</span>
            <span class="n">cnn_backbone</span><span class="o">=</span><span class="n">cnn_backbone</span><span class="p">,</span>
            <span class="n">sos_id</span><span class="o">=</span><span class="n">stoi</span><span class="p">[</span><span class="s2">&quot;&lt;SOS&gt;&quot;</span><span class="p">],</span>
            <span class="n">eos_id</span><span class="o">=</span><span class="n">stoi</span><span class="p">[</span><span class="s2">&quot;&lt;EOS&gt;&quot;</span><span class="p">],</span>
            <span class="n">pad_id</span><span class="o">=</span><span class="n">stoi</span><span class="p">[</span><span class="s2">&quot;&lt;PAD&gt;&quot;</span><span class="p">],</span>
            <span class="n">blank_id</span><span class="o">=</span><span class="n">stoi</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;&lt;BLANK&gt;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="n">use_ctc_head</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Token IDs:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      SOS:   </span><span class="si">{</span><span class="n">stoi</span><span class="p">[</span><span class="s1">&#39;&lt;SOS&gt;&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      EOS:   </span><span class="si">{</span><span class="n">stoi</span><span class="p">[</span><span class="s1">&#39;&lt;EOS&gt;&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      PAD:   </span><span class="si">{</span><span class="n">stoi</span><span class="p">[</span><span class="s1">&#39;&lt;PAD&gt;&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      BLANK: </span><span class="si">{</span><span class="n">stoi</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;&lt;BLANK&gt;&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">None</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      SPACE: </span><span class="si">{</span><span class="n">stoi</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;NOT FOUND&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Load weights</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading weights into model...&quot;</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[OK] Model loaded&quot;</span><span class="p">)</span>

        <span class="c1"># Create ONNX wrapper</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Creating ONNX wrapper...&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   max_length from config: </span><span class="si">{</span><span class="n">max_length</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;   ONNX will use: </span><span class="si">{</span><span class="n">max_length</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> steps (max_length + 1 for compatibility)&quot;</span>
        <span class="p">)</span>
        <span class="n">onnx_model</span> <span class="o">=</span> <span class="n">TRBAONNXWrapper</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="n">max_length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">onnx_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

        <span class="c1"># Create dummy input</span>
        <span class="n">dummy_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">img_h</span><span class="p">,</span> <span class="n">img_w</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input shape: </span><span class="si">{</span><span class="n">dummy_input</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Test model before export</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Testing model before export...&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">onnx_model</span><span class="p">(</span><span class="n">dummy_input</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output shape: </span><span class="si">{</span><span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected: [1, </span><span class="si">{</span><span class="n">max_length</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">num_classes</span><span class="si">}</span><span class="s2">] (max_length + 1 steps)&quot;</span><span class="p">)</span>

        <span class="c1"># Export to ONNX</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Exporting to ONNX (opset </span><span class="si">{</span><span class="n">opset_version</span><span class="si">}</span><span class="s2">)...&quot;</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">onnx</span><span class="o">.</span><span class="n">export</span><span class="p">(</span>
            <span class="n">onnx_model</span><span class="p">,</span>
            <span class="n">dummy_input</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">output_path</span><span class="p">),</span>
            <span class="n">export_params</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">opset_version</span><span class="o">=</span><span class="n">opset_version</span><span class="p">,</span>
            <span class="n">do_constant_folding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">],</span>
            <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;logits&quot;</span><span class="p">],</span>
            <span class="n">dynamic_axes</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">},</span>
                <span class="s2">&quot;logits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">},</span>
            <span class="p">},</span>
            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[OK] ONNX model saved to: </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Verify ONNX model</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">onnx</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Verifying ONNX model...&quot;</span><span class="p">)</span>
        <span class="n">onnx_model_proto</span> <span class="o">=</span> <span class="n">onnx</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_path</span><span class="p">))</span>
        <span class="n">onnx</span><span class="o">.</span><span class="n">checker</span><span class="o">.</span><span class="n">check_model</span><span class="p">(</span><span class="n">onnx_model_proto</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[OK] ONNX model is valid&quot;</span><span class="p">)</span>

        <span class="c1"># Simplify if requested</span>
        <span class="k">if</span> <span class="n">simplify</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">onnxsim</span>

                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Simplifying ONNX model...&quot;</span><span class="p">)</span>
                <span class="n">model_simplified</span><span class="p">,</span> <span class="n">check</span> <span class="o">=</span> <span class="n">onnxsim</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">onnx_model_proto</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
                    <span class="n">onnx</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model_simplified</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_path</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[OK] ONNX model simplified&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[WARNING] Simplification failed, using original model&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;[WARNING] onnx-simplifier not installed, skipping simplification&quot;</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Install with: pip install onnx-simplifier&quot;</span><span class="p">)</span>

        <span class="c1"># Test ONNX inference</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Testing ONNX inference...&quot;</span><span class="p">)</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">ort</span><span class="o">.</span><span class="n">InferenceSession</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_path</span><span class="p">))</span>

            <span class="n">ort_inputs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="n">dummy_input</span><span class="o">.</span><span class="n">numpy</span><span class="p">()}</span>
            <span class="n">ort_outputs</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ort_inputs</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[OK] ONNX inference works!&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Output shape: </span><span class="si">{</span><span class="n">ort_outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Compare with PyTorch</span>
            <span class="n">torch_output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">onnx_output</span> <span class="o">=</span> <span class="n">ort_outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">max_diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">torch_output</span> <span class="o">-</span> <span class="n">onnx_output</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Max difference vs PyTorch: </span><span class="si">{</span><span class="n">max_diff</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">max_diff</span> <span class="o">&lt;</span> <span class="mf">1e-4</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [OK] Outputs match!&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [WARNING] Outputs differ slightly&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[WARNING] ONNX inference test failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Print summary</span>
        <span class="n">file_size_mb</span> <span class="o">=</span> <span class="n">output_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[OK] Export complete! Model size: </span><span class="si">{</span><span class="n">file_size_mb</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Input shape: [batch_size, 3, </span><span class="si">{</span><span class="n">img_h</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">img_w</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output shape: [batch_size, </span><span class="si">{</span><span class="n">max_length</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">num_classes</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Decoding: Greedy (argmax over last dimension)&quot;</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2026, Konstantin Kozhin.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>